/* Copyright (C) YOOtheme GmbH, YOOtheme Proprietary Use License (http://www.yootheme.com/license) */

function compileLess(e,s){var l=path.dirname(s),o=path.basename(s),t=path.join(l,"__"+o+"_tmp.less"),p=[];return e.forEach(function(e){p.push('@import "'+e+'";')}),fs.writeFileSync(t,p.join("\n")),gulp.src(t).pipe(less(_lesssettings)).pipe(rename(o)).pipe(gulp.dest(l)).on("end",function(){fs.unlinkSync(t)})}function tagFiles(e,s,l,o,t){var p=null,r=null;if(null===t&&(t="_build/dist"),null!==e){var u="/* "+o.copyright[0]+", "+o.license[0]+" */\n\n";r=gulp.src(e,{cwd:t}).pipe(insert.prepend(u)).pipe(gulp.dest(t)),p=null===p?r:merge(p,r)}if(null!==s){var i="// "+o.copyright[0]+", "+o.license[0]+" */\n\n";r=gulp.src(s,{cwd:t}).pipe(insert.prepend(i)).pipe(gulp.dest(t)),p=null===p?r:merge(p,r)}if(null!==l){var c=[];c.push("<?php"),c.push("/**"),c.push("* @package   "+o.name),c.push("* @author    "+o.author+" "+o.authorUrl),c.push("* @copyright "+o.copyright),c.push("* @license   http://www.gnu.org/licenses/gpl.html GNU/GPL"),c.push("*/"),r=gulp.src(l,{cwd:t}).pipe(replace(/^(<\?php)\s?\n/g,c.join("\n")+"\n\n")).pipe(gulp.dest(t)),p=null===p?r:merge(p,r)}return p}var del=require("del"),fs=require("fs"),glob=require("glob-all"),merge=require("merge-stream"),path=require("path"),runSeq=require("run-sequence"),xml2js=require("xml2js"),gulp=require("gulp"),hashsum=require("gulp-hashsum"),insert=require("gulp-insert"),less=require("gulp-less"),rename=require("gulp-rename"),replace=require("gulp-replace"),uglify=require("gulp-uglify"),util=require("gulp-util"),zip=require("gulp-zip");-1!==__dirname.indexOf("warp",__dirname.length-"warp".length)&&process.chdir("../");var _suffix=null,_themeXML=null,_wordpressXML=null,_warpXML=null,_lesssettings={relativeUrls:!0},_nevercopy=["!_build{/**,}","!node_modules{/**,}","!temp/**","!vendor/**","!warp/_build{/**,}","!warp/node_modules{/**,}","!warp/build*.php","!warp/gulpfile.js","!warp/package.json","!warp/composer.*","!.*","!**composer.*","!_buildfile.php","!config.json","!*.zip"],_output=util.env.output||util.env.o||"_build",_bsc=util.env.bootstrapcore||util.env.b||"../../../media/jui/less";0===_bsc.indexOf("/")&&fs.existsSync(_bsc)&&(_bsc=path.relative(path.join(process.cwd(),"css"),_bsc)),gulp.task("default",["compile"]),gulp.task("build",function(e){runSeq("compile-all","build-joomla","build-joomla.2.5","build-wordpress",e)}),gulp.task("clean",function(e){del(["_build/dist"],e)}),gulp.task("build-joomla",function(e){_suffix="j3",runSeq("joomla-copy-core","loadXML","prepare","zip-dist","clean",e)}),gulp.task("joomla-copy-core",function(){var e=["**","!css/woocommerce*","!less/woocommerce{*,/**}","!styles/**/woocommerce*","!warp/systems/wordpress{/**,}"];return gulp.src(e.concat(_nevercopy)).pipe(gulp.dest("_build/dist"))}),gulp.task("build-joomla.2.5",function(e){return fs.existsSync("_build/joomla.2.5")?(_suffix="j25",void runSeq("joomla.2.5-copy-core","joomla.2.5-copy-core-2","joomla.2.5-copy-core-3","loadXML","prepare","zip-dist","clean",e)):void e()}),gulp.task("joomla.2.5-copy-core",function(){var e=["css/**","!css/woocommerce**","!css/bootstrap**","images/**","js/**","layouts/**","less/**","!less/bootstrap{*,/**}","styles/**","!styles/**/bootstrap*","!styles/**/woocommerce*","warp/**","!warp/systems/joomla/layouts/**","!warp/systems/wordpress{/**,}","widgetkit/**","*"];return gulp.src(e.concat(_nevercopy),{base:"./"}).pipe(gulp.dest("_build/dist"))}),gulp.task("joomla.2.5-copy-core-2",function(){return gulp.src(["_build/joomla.2.5/**"]).pipe(gulp.dest("_build/dist"))}),gulp.task("joomla.2.5-copy-core-3",function(){return gulp.src(["warp/_build/joomla.2.5/**"]).pipe(gulp.dest("_build/dist"))}),gulp.task("build-wordpress",function(e){return fs.existsSync("_build/wordpress")?(_suffix="wp",void runSeq("wordpress-copy-core","wordpress-copy-core-2","wordpress-copy-core-3","loadXML","worpdress-create-stylecss","prepare","zip-dist","clean",e)):void e()}),gulp.task("wordpress-copy-core",function(){var e=["css/**","!css/bootstrap**","images/**","js/**","layouts/{theme,theme.config,widget}.php","less/**","!less/bootstrap{*,/**}","styles/**","!styles/**/bootstrap.*","warp/**","!warp/systems/joomla{/**,}","widgetkit/**","fonts/**","CHANGELOG.md","config.default.json","config.php","config.xml"];return gulp.src(e.concat(_nevercopy),{base:"./"}).pipe(gulp.dest("_build/dist"))}),gulp.task("wordpress-copy-core-2",function(){return gulp.src(["_build/wordpress/**"]).pipe(gulp.dest("_build/dist"))}),gulp.task("wordpress-copy-core-3",function(){return gulp.src(["warp/_build/wordpress/**"]).pipe(gulp.dest("_build/dist"))}),gulp.task("worpdress-create-stylecss",function(e){if(null===_wordpressXML)e("wordpressXML has not been loaded");else{var s=[];s.push("/**"),s.push(" * Theme Name: "+_wordpressXML.name),s.push(" * Theme URI: http://www.yootheme.com"),s.push(" * Description: "+_wordpressXML.description),s.push(" * Version: "+_wordpressXML.version),s.push(" * Author: YOOtheme"),s.push(" * Author URI: http://www.yootheme.com"),s.push(" */"),fs.writeFileSync("_build/dist/style.css",s.join("\n")),e(null)}}),gulp.task("loadXML",function(e){_themeXML=null,_wordpressXML=null,_warpXML=null;var s=null,l=new xml2js.Parser;"wp"==_suffix&&(s=fs.readFileSync("_build/wordpress/theme.xml"),l.parseString(s,function(e,s){_wordpressXML=s.theme})),s=fs.readFileSync("templateDetails.xml"),l.parseString(s,function(s,l){null!==s&&e(s),_themeXML=l.extension}),s=fs.readFileSync("warp/warp.xml"),l.parseString(s,function(s,l){null!==s&&e(s),_warpXML=l.info}),e(null===_themeXML?"themeXML could not be loaded":"wp"==_suffix&&null===_themeXML?"wordpressXML could not be loaded":null===_warpXML?"WarpXML could not be loaded":null)}),gulp.task("prepare",function(e){runSeq("uglify","tag","checksum",e)}),gulp.task("uglify",function(){return gulp.src(["_build/dist/**/*.js","!_build/dist/js/theme.js"]).pipe(uglify()).pipe(gulp.dest("_build/dist"))}),gulp.task("tag",["tag-theme-files","tag-warp-files"]),gulp.task("tag-theme-files",function(e){var s=_themeXML;return"wp"==_suffix&&(s=_wordpressXML),null===s&&e("XML data for tagging files is missing."),tagFiles(["**/*.js","**/*.css","!warp/**","!style.css"],["**/*.less","!warp/**"],["**/*.php","!warp/**"],s,"_build/dist")}),gulp.task("tag-warp-files",function(e){return null===_warpXML&&e("WarpXML has not been loaded."),tagFiles(["**/*.js","**/*.css","!vendor/**"],["**/*.less","!vendor/**"],["**/*.php","!vendor/**"],_warpXML,"_build/dist/warp")}),gulp.task("checksum",function(){return gulp.src(["_build/dist/**","!_build/dist/checksums*"]).pipe(hashsum({dest:"_build/dist",filename:"checksums",hash:"md5",delimiter:" "}))}),gulp.task("zip-dist",function(e){if(null!==_suffix&&null!==_themeXML){var s=_themeXML.name+"_"+_suffix+".zip",l=gulp.src("_build/dist/**/*");return"wp"==_suffix&&l.pipe(rename(function(e){e.dirname=_themeXML.name+"_"+_suffix+"/"+e.dirname})),l.pipe(zip(s)).pipe(gulp.dest(_output)),l}e("suffix or themeXML not available")}),gulp.task("compile",function(e){-1!==__dirname.indexOf("wp-content")?runSeq("compile-theme-css","compile-woocommerce-css",e):runSeq("compile-all",e)}),gulp.task("compile-all",function(e){return fs.existsSync(path.normalize("css/"+_bsc))?void runSeq("compile-theme-css","compile-bootstrap-css","compile-woocommerce-css",e):void e("The given path to the Bootstrap core does not exist!")}),gulp.task("compile-theme-css",["compile-default-theme-css","compile-styles-theme-css"]),gulp.task("compile-bootstrap-css",["copy-tmp-bootstrap-less","compile-default-bootstrap-css","compile-styles-boostrap-css","remove-tmp-bootstrap-less"]),gulp.task("compile-woocommerce-css",["copy-woocommerce-less","compile-default-woocommerce-css","compile-styles-woocommerce-css","remove-woocommerce-less"]),gulp.task("copy-tmp-bootstrap-less",function(){return gulp.src(["less/bootstrap.less"]).pipe(replace("../../../media/jui/less",_bsc)).pipe(rename("__bootstrap_tmp.less")).pipe(gulp.dest("less"))}),gulp.task("remove-tmp-bootstrap-less",["copy-tmp-bootstrap-less","compile-default-bootstrap-css","compile-styles-boostrap-css"],function(e){del(["less/__bootstrap_tmp.less"],e)}),gulp.task("copy-woocommerce-less",function(){return gulp.src(["_build/wordpress/less/**"]).pipe(gulp.dest("less"))}),gulp.task("remove-woocommerce-less",["copy-woocommerce-less","compile-default-woocommerce-css","compile-styles-woocommerce-css"],function(e){del(["less/woocommerce*"],e)}),gulp.task("compile-default-theme-css",function(){return compileLess(["../less/theme.less","../less/style.less"],"css/theme.css")}),gulp.task("compile-default-bootstrap-css",["copy-tmp-bootstrap-less"],function(){return compileLess(["../less/__bootstrap_tmp.less","../less/style.less"],"css/bootstrap.css")}),gulp.task("compile-default-woocommerce-css",["copy-woocommerce-less"],function(){return compileLess(["../less/woocommerce.less","../less/style.less"],"css/woocommerce.css")}),gulp.task("compile-styles-theme-css",function(){var e=glob.sync("styles/*/style.less"),s=null,l=null;return e.forEach(function(e){s=compileLess(["../../../less/theme.less","../style.less"],path.join(path.dirname(e),"css/theme.css")),l=null===l?s:merge(l,s)}),l}),gulp.task("compile-styles-boostrap-css",["copy-tmp-bootstrap-less"],function(){var e=glob.sync("styles/*/style.less"),s=null,l=null;return e.forEach(function(e){s=compileLess(["../../../less/__bootstrap_tmp.less","../style.less"],path.join(path.dirname(e),"css/bootstrap.css")),l=null===l?s:merge(l,s)}),l}),gulp.task("compile-styles-woocommerce-css",["copy-woocommerce-less"],function(){var e=glob.sync("styles/*/style.less"),s=null,l=null;return e.forEach(function(e){s=compileLess(["../../../less/woocommerce.less","../style.less"],path.join(path.dirname(e),"css/woocommerce.css")),l=null===l?s:merge(l,s)}),l});